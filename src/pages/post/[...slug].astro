---
import '@milkdown/crepe/theme/common/style.css';
import '@milkdown/crepe/theme/frame.css';
import Layout from '@/layouts/layout.astro';
import { PostHeader } from '@/components/PostHeader';
import { TagList } from '@/components/TagBadge';
import { getDocumentBySlugWithAuthor } from '@/db/documents';
import { getDocumentTags } from '@/db/tags';

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Fetch document by slug with author info
const post = await getDocumentBySlugWithAuthor(slug);

if (!post) {
  return Astro.redirect('/');
}

// Fetch tags for the document
const postTags = await getDocumentTags(post.id);
---

<Layout title={post.title}>
  <div class='w-full flex flex-col gap-6'>
    <PostHeader
      title={post.title}
      rawMarkdown={post.rawMarkdown || ''}
      slug={post.slug}
      client:load
    />

    <div class='w-full max-w-4xl mx-auto px-1'>
      <!-- Back navigation and metadata -->
      <div class='flex items-center justify-between mb-6'>
        <a
          href='/'
          class='inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors group'
        >
          <svg
            xmlns='http://www.w3.org/2000/svg'
            width='16'
            height='16'
            viewBox='0 0 24 24'
            fill='none'
            stroke='currentColor'
            stroke-width='2'
            stroke-linecap='round'
            stroke-linejoin='round'
            class='group-hover:-translate-x-0.5 transition-transform'
          >
            <path d='m12 19-7-7 7-7'></path>
            <path d='M19 12H5'></path>
          </svg>
          <span>Volver</span>
        </a>

        <div class='flex items-center gap-3 text-xs text-muted-foreground'>
          {
            post.authorName && (
              <span class='flex items-center gap-1.5'>
                <svg
                  xmlns='http://www.w3.org/2000/svg'
                  width='14'
                  height='14'
                  viewBox='0 0 24 24'
                  fill='none'
                  stroke='currentColor'
                  stroke-width='2'
                  stroke-linecap='round'
                  stroke-linejoin='round'
                >
                  <path d='M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2' />
                  <circle cx='12' cy='7' r='4' />
                </svg>
                {post.authorName}
              </span>
            )
          }
          <time datetime={post.createdAt?.toISOString()}>
            {
              new Intl.DateTimeFormat('es', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              }).format(post.createdAt)
            }
          </time>
        </div>
      </div>

      {/* Tags del documento */}
      {
        postTags.length > 0 && (
          <div class='mb-4'>
            <TagList tags={postTags} size='md' clickable={true} />
          </div>
        )
      }

      <!-- Editor en modo solo lectura -->
      <div id='app' class='w-full min-h-[70vh] milkdown-readonly'></div>
    </div>
  </div>
</Layout>

<script define:vars={{ rawMarkdown: post.rawMarkdown }}>
  window.__POST_CONTENT__ = rawMarkdown;
</script>

<script>
  import { Crepe } from '@milkdown/crepe';

  let crepeInstance: Crepe | null = null;

  async function initReadonlyEditor() {
    if (crepeInstance) {
      crepeInstance.destroy();
      crepeInstance = null;
    }

    const content = (window as any).__POST_CONTENT__ || '';

    crepeInstance = new Crepe({
      root: '#app',
      defaultValue: content,
    });

    // Configurar como solo lectura
    crepeInstance.setReadonly(true);

    await crepeInstance.create();
  }

  initReadonlyEditor();

  document.addEventListener('astro:before-swap', () => {
    if (crepeInstance) {
      console.log('Limpiando editor readonly de memoria...');
      crepeInstance.destroy();
      crepeInstance = null;
    }
  });
</script>

<style>
  /* Ocultar elementos de edición en modo readonly */
  .milkdown-readonly :global(.crepe-toolbar),
  .milkdown-readonly :global(.crepe-menu),
  .milkdown-readonly :global([data-crepe-toolbar]),
  .milkdown-readonly :global(.milkdown-menu) {
    display: none !important;
  }

  /* Cursor por defecto en modo lectura */
  .milkdown-readonly :global(.ProseMirror) {
    cursor: default;
  }

  /* Desactivar selección de texto para evitar confusión del usuario */
  .milkdown-readonly :global(.ProseMirror)::selection,
  .milkdown-readonly :global(.ProseMirror) *::selection {
    background: transparent;
  }
</style>
