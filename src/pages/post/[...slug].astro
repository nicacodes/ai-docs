---
import "@milkdown/crepe/theme/common/style.css";
import "@milkdown/crepe/theme/frame.css";
import Layout from "@/layouts/layout.astro";
import { GlobalHeader } from "@/components/GlobalHeader";
import { getDb } from "@/db/client";
import { documents } from "@/db/schema";
import { eq } from "drizzle-orm";

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect("/");
}

// Fetch document by slug
const db = getDb();
const rows = await db
  .select({
    id: documents.id,
    title: documents.title,
    slug: documents.slug,
    rawMarkdown: documents.rawMarkdown,
    createdAt: documents.createdAt,
  })
  .from(documents)
  .where(eq(documents.slug, slug))
  .limit(1);

const post = rows[0];

if (!post) {
  return Astro.redirect("/");
}
---

<Layout title={post.title}>
  <div class="w-full flex flex-col gap-6">
    <GlobalHeader showSearch={false} client:load />

    <div class="w-full max-w-4xl mx-auto px-1">
      <!-- Back navigation and metadata -->
      <div class="flex items-center justify-between mb-6">
        <a
          href="/"
          class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors group"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="group-hover:-translate-x-0.5 transition-transform"
          >
            <path d="m12 19-7-7 7-7"></path>
            <path d="M19 12H5"></path>
          </svg>
          <span>Volver</span>
        </a>

        <time
          datetime={post.createdAt?.toISOString()}
          class="text-xs text-muted-foreground"
        >
          {
            new Intl.DateTimeFormat("es", {
              year: "numeric",
              month: "long",
              day: "numeric",
            }).format(post.createdAt)
          }
        </time>
      </div>

      <!-- Editor en modo solo lectura -->
      <div id="app" class="w-full min-h-[70vh] milkdown-readonly"></div>
    </div>
  </div>
</Layout>

<script define:vars={{ rawMarkdown: post.rawMarkdown }}>
  window.__POST_CONTENT__ = rawMarkdown;
</script>

<script>
  import { Crepe } from "@milkdown/crepe";

  let crepeInstance: Crepe | null = null;

  async function initReadonlyEditor() {
    if (crepeInstance) {
      crepeInstance.destroy();
      crepeInstance = null;
    }

    const content = (window as any).__POST_CONTENT__ || "";

    crepeInstance = new Crepe({
      root: "#app",
      defaultValue: content,
    });

    // Configurar como solo lectura
    crepeInstance.setReadonly(true);

    await crepeInstance.create();
  }

  initReadonlyEditor();

  document.addEventListener("astro:before-swap", () => {
    if (crepeInstance) {
      console.log("Limpiando editor readonly de memoria...");
      crepeInstance.destroy();
      crepeInstance = null;
    }
  });
</script>

<style>
  /* Ocultar elementos de edición en modo readonly */
  .milkdown-readonly :global(.crepe-toolbar),
  .milkdown-readonly :global(.crepe-menu),
  .milkdown-readonly :global([data-crepe-toolbar]),
  .milkdown-readonly :global(.milkdown-menu) {
    display: none !important;
  }

  /* Cursor por defecto en modo lectura */
  .milkdown-readonly :global(.ProseMirror) {
    cursor: default;
  }

  /* Desactivar selección de texto para evitar confusión del usuario */
  .milkdown-readonly :global(.ProseMirror)::selection,
  .milkdown-readonly :global(.ProseMirror) *::selection {
    background: transparent;
  }
</style>
