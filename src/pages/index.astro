---
import Layout from "@/layouts/layout.astro";
import { HomeHeader } from "@/components/HomeHeader";
import { PostList } from "@/components/PostList";
import { getDb } from "@/db/client";
import { documents } from "@/db/schema";
import { sql } from "drizzle-orm";

export const prerender = false;

// Fetch posts server-side
const db = getDb();
const rows = await db
  .select({
    id: documents.id,
    title: documents.title,
    slug: documents.slug,
    rawMarkdown: documents.rawMarkdown,
    createdAt: documents.createdAt,
  })
  .from(documents)
  .orderBy(sql`${documents.createdAt} DESC`)
  .limit(20);

const initialPosts = rows.map((row) => ({
  id: row.id,
  title: row.title,
  slug: row.slug,
  excerpt:
    row.rawMarkdown
      .replace(/^#.*$/gm, "")
      .replace(/[#*_`]/g, "")
      .trim()
      .slice(0, 160) + (row.rawMarkdown.length > 160 ? "..." : ""),
  createdAt: row.createdAt,
}));
---

<Layout title="AI Blog - Inicio">
  <div class="space-y-8">
    <HomeHeader client:load />

    <main class="px-1">
      <header class="mb-8">
        <h1
          class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-foreground to-muted-foreground bg-clip-text text-transparent"
        >
          Últimos Posts
        </h1>
        <p class="text-muted-foreground mt-2 text-lg">
          Explora ideas, tutoriales y más
        </p>
      </header>

      <PostList client:load initialPosts={initialPosts} />
    </main>
  </div>
</Layout>
